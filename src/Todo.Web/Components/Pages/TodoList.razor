@page "/todos"
@rendermode InteractiveServer
@inject ITodoService TodoService

<PageTitle>Todo List</PageTitle>

<div class="todo-container">
    <h1>Todo List</h1>

    <div class="todo-input">
        <input type="text"
               @bind="newTodoTitle"
               @bind:event="oninput"
               @onkeydown="HandleKeyDown"
               placeholder="What needs to be done?"
               autofocus />
        <button class="btn btn-primary" @onclick="AddTodo" disabled="@string.IsNullOrWhiteSpace(newTodoTitle)">
            Add
        </button>
    </div>

    @if (todos is null)
    {
        <p class="loading">Loading...</p>
    }
    else if (!todos.Any())
    {
        <p class="empty-state">No todos yet. Add one above!</p>
    }
    else
    {
        <div class="todo-stats">
            <span>@todos.Count(t => !t.IsCompleted) items left</span>
            @if (todos.Any(t => t.IsCompleted))
            {
                <button class="btn btn-link" @onclick="ClearCompleted">
                    Clear completed
                </button>
            }
        </div>

        <ul class="todo-list">
            @foreach (var todo in todos)
            {
                <TodoItemComponent
                    Item="todo"
                    OnToggle="ToggleTodo"
                    OnDelete="ConfirmDelete" />
            }
        </ul>
    }
</div>

@if (showDeleteModal)
{
    <div class="modal-backdrop" @onclick="CloseDeleteModal" aria-label="Close dialog"></div>
    <div class="delete-modal" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title">
        <h3 id="delete-modal-title">Are you sure?</h3>
        <p>This will permanently delete the todo item.</p>
        <div class="modal-buttons">
            <button class="btn btn-danger" @onclick="ConfirmDeleteYes">Yes</button>
            <button class="btn btn-secondary" @onclick="CloseDeleteModal">No</button>
        </div>
    </div>
}

@code {
    private List<TodoItem>? todos;
    private string newTodoTitle = string.Empty;
    private bool showDeleteModal;
    private Guid? todoToDeleteId;

    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    private async Task LoadTodos()
    {
        var items = await TodoService.GetAllAsync();
        todos = items.ToList();
    }

    private async Task AddTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle))
            return;

        await TodoService.AddAsync(newTodoTitle);
        newTodoTitle = string.Empty;
        await LoadTodos();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTodo();
        }
    }

    private async Task ToggleTodo(Guid id)
    {
        await TodoService.ToggleAsync(id);
        await LoadTodos();
    }

    private void ConfirmDelete(Guid id)
    {
        todoToDeleteId = id;
        showDeleteModal = true;
    }

    private async Task ConfirmDeleteYes()
    {
        if (todoToDeleteId.HasValue)
        {
            await TodoService.DeleteAsync(todoToDeleteId.Value);
            await LoadTodos();
        }
        CloseDeleteModal();
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        todoToDeleteId = null;
    }

    private async Task ClearCompleted()
    {
        await TodoService.ClearCompletedAsync();
        await LoadTodos();
    }
}

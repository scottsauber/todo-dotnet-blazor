@page "/todos"
@rendermode InteractiveServer
@inject ITodoService TodoService

<PageTitle>Todo List</PageTitle>

<div class="todo-container">
    <h1>Todo List</h1>

    <div class="todo-input">
        <input type="text"
               @bind="newTodoTitle"
               @bind:event="oninput"
               @onkeydown="HandleKeyDown"
               placeholder="What needs to be done?"
               autofocus />
        <button class="btn btn-primary" @onclick="AddTodo" disabled="@string.IsNullOrWhiteSpace(newTodoTitle)">
            Add
        </button>
    </div>

    @if (todos is null)
    {
        <p class="loading">Loading...</p>
    }
    else if (!todos.Any())
    {
        <p class="empty-state">No todos yet. Add one above!</p>
    }
    else
    {
        <div class="todo-stats">
            <span>@todos.Count(t => !t.IsCompleted) items left</span>
            @if (todos.Any(t => t.IsCompleted))
            {
                <button class="btn btn-link" @onclick="ClearCompleted">
                    Clear completed
                </button>
            }
        </div>

        <ul class="todo-list">
            @foreach (var todo in todos)
            {
                <TodoItemComponent
                    Item="todo"
                    OnToggle="ToggleTodo"
                    OnDelete="ShowDeleteConfirmation" />
            }
        </ul>
    }
</div>

@if (showDeleteConfirmation)
{
    <div class="modal-backdrop"></div>
    <div class="delete-confirmation-modal" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle" @onkeydown="HandleModalKeyDown">
        <h3 id="deleteModalTitle">Confirm Delete</h3>
        <p>Are you sure you want to delete this todo?</p>
        <div class="modal-buttons">
            <button class="btn btn-danger" @onclick="ConfirmDelete">Yes</button>
            <button class="btn btn-secondary" @onclick="CancelDelete">No</button>
        </div>
    </div>
}

@code {
    private List<TodoItem>? todos;
    private string newTodoTitle = string.Empty;
    private bool showDeleteConfirmation;
    private Guid? todoIdToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    private async Task LoadTodos()
    {
        var items = await TodoService.GetAllAsync();
        todos = items.ToList();
    }

    private async Task AddTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle))
            return;

        await TodoService.AddAsync(newTodoTitle);
        newTodoTitle = string.Empty;
        await LoadTodos();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTodo();
        }
    }

    private void HandleModalKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            CancelDelete();
        }
    }

    private async Task ToggleTodo(Guid id)
    {
        await TodoService.ToggleAsync(id);
        await LoadTodos();
    }

    private void ShowDeleteConfirmation(Guid id)
    {
        todoIdToDelete = id;
        showDeleteConfirmation = true;
    }

    private async Task ConfirmDelete()
    {
        if (todoIdToDelete.HasValue)
        {
            await TodoService.DeleteAsync(todoIdToDelete.Value);
            await LoadTodos();
        }
        CancelDelete();
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        todoIdToDelete = null;
    }

    private async Task ClearCompleted()
    {
        await TodoService.ClearCompletedAsync();
        await LoadTodos();
    }
}
